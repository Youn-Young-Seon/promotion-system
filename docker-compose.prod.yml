version: '3.8'

services:
  # API Gateway
  api-gateway:
    build:
      context: .
      dockerfile: apps/api-gateway/Dockerfile
    container_name: api-gateway
    ports:
      - '4000:4000'
    environment:
      NODE_ENV: production
      REDIS_HOST: redis
      KAFKA_BROKERS: kafka:9093
      ETCD_HOSTS: etcd:2379
    depends_on:
      - redis
      - kafka
      - etcd
      - coupon-service
      - point-service
      - timesale-service
    networks:
      - promotion-network
    restart: unless-stopped

  # Coupon Service
  coupon-service:
    build:
      context: .
      dockerfile: apps/coupon-service/Dockerfile
    container_name: coupon-service
    ports:
      - '3001:3001'
      - '50051:50051'
    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://postgres:password@postgres-coupon:5432/coupon_db?schema=public
      REDIS_HOST: redis
      KAFKA_BROKERS: kafka:9093
      ETCD_HOSTS: etcd:2379
      GRPC_PORT: 50051
      SERVICE_HOST: coupon-service
      SERVICE_PORT: 3001
    depends_on:
      - postgres-coupon
      - redis
      - kafka
      - etcd
    networks:
      - promotion-network
    restart: unless-stopped

  # Point Service
  point-service:
    build:
      context: .
      dockerfile: apps/point-service/Dockerfile
    container_name: point-service
    ports:
      - '3002:3002'
      - '50052:50052'
    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://postgres:password@postgres-point:5432/point_db?schema=public
      REDIS_HOST: redis
      KAFKA_BROKERS: kafka:9093
      ETCD_HOSTS: etcd:2379
      GRPC_PORT: 50052
      SERVICE_HOST: point-service
      SERVICE_PORT: 3002
    depends_on:
      - postgres-point
      - redis
      - kafka
      - etcd
    networks:
      - promotion-network
    restart: unless-stopped

  # TimeSale Service
  timesale-service:
    build:
      context: .
      dockerfile: apps/timesale-service/Dockerfile
    container_name: timesale-service
    ports:
      - '3003:3003'
      - '50053:50053'
    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://postgres:password@postgres-timesale:5432/timesale_db?schema=public
      REDIS_HOST: redis
      KAFKA_BROKERS: kafka:9093
      ETCD_HOSTS: etcd:2379
      GRPC_PORT: 50053
      SERVICE_HOST: timesale-service
      SERVICE_PORT: 3003
    depends_on:
      - postgres-timesale
      - redis
      - kafka
      - etcd
    networks:
      - promotion-network
    restart: unless-stopped

networks:
  promotion-network:
    external: true

volumes:
  postgres-coupon-data:
  postgres-point-data:
  postgres-timesale-data:
  redis-data:
  zookeeper-data:
  zookeeper-logs:
  kafka-data:
  etcd-data:
